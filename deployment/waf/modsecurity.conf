# =============================================================================
# ModSecurity Core Configuration for Catalyst (Prebid Server)
# =============================================================================
# This is a production-ready configuration optimized for ad-tech workloads.
# It enables protection while allowing legitimate OpenRTB traffic.
# =============================================================================

# -- Rule Engine Initialization ------------------------------------------------

# Enable ModSecurity (On = block, DetectionOnly = log only)
SecRuleEngine On

# -- Request Body Handling -----------------------------------------------------

# Enable request body access (required for JSON inspection)
SecRequestBodyAccess On

# Maximum request body size (1MB - matches your nginx config)
SecRequestBodyLimit 1048576

# What to do if the request body limit is reached
SecRequestBodyLimitAction Reject

# Maximum size of individual multipart/form-data files (not used in OpenRTB)
SecRequestBodyNoFilesLimit 1048576

# -- Response Body Handling ----------------------------------------------------

# Don't inspect response bodies (not needed for API server, improves performance)
SecResponseBodyAccess Off

# -- Filesystem Configuration --------------------------------------------------

# Temporary directory for request body processing
SecTmpDir /tmp/modsecurity/tmp

# Persistent data directory
SecDataDir /tmp/modsecurity/data

# Upload directory
SecUploadDir /tmp/modsecurity/upload

# -- Debug Log Configuration ---------------------------------------------------

# Debug log (set to 0 in production, 3-9 for debugging)
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 0

# -- Audit Log Configuration ---------------------------------------------------

# Enable audit logging for blocked requests
SecAuditEngine RelevantOnly

# Log only blocked requests and errors
SecAuditLogRelevantStatus "^(?:4(?:0[0-3]|1[0-9]|2[0-9])|5)"

# Audit log parts:
# A = Audit log header
# B = Request headers
# C = Request body (careful with PII!)
# E = Response body (disabled)
# F = Final response headers
# H = Audit log trailer (rule messages)
# I = Reduced request body (recommended)
# J = File upload info
# K = Matched rules
# Z = Final boundary
SecAuditLogParts ABIFHKZ

# Audit log type (Serial = single file, Concurrent = per-request files)
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# -- Processing Limits ---------------------------------------------------------

# Maximum number of arguments in a request (prevent parameter pollution)
SecArgumentsLimit 1000

# PCRE match limits (prevent ReDoS)
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# -- Miscellaneous -------------------------------------------------------------

# Server signature (hide server details)
SecServerSignature "Server"

# Cookie format (standard v0 cookies)
SecCookieFormat 0

# Unicode mapping (for normalization)
SecUnicodeMapFile /etc/nginx/modsecurity/unicode.mapping 20127

# -- Content-Type Handling -----------------------------------------------------

# Request body processor for JSON (critical for OpenRTB)
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:200001,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# Allow application/json content type
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:200002,phase:1,t:none,t:lowercase,pass,nolog"

# -- Response Status Codes -----------------------------------------------------

# Default actions for rules
SecDefaultAction "phase:1,deny,log,status:403"
SecDefaultAction "phase:2,deny,log,status:403"

# -- Include OWASP CRS Rules ---------------------------------------------------

# Include OWASP Core Rule Set
Include /etc/nginx/modsecurity/crs/crs-setup.conf
Include /etc/nginx/modsecurity/crs/rules/*.conf

# Include custom ad-tech rules (loaded after CRS)
Include /etc/nginx/modsecurity/rules/catalyst-rules.conf
