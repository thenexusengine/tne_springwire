# =============================================================================
# OWASP Core Rule Set (CRS) Setup Configuration for Catalyst
# =============================================================================
# This configures the OWASP CRS behavior for ad-tech API workloads.
# Tuned for low false positives on legitimate OpenRTB traffic.
# =============================================================================

# -- Paranoia Level ------------------------------------------------------------
# 1 = Low (recommended for production start)
# 2 = Standard
# 3 = High
# 4 = Maximum
SecAction \
    "id:900000,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.blocking_paranoia_level=1,\
    setvar:tx.detection_paranoia_level=1"

# -- Anomaly Scoring Mode ------------------------------------------------------
# Anomaly mode: requests accumulate scores, blocked if threshold exceeded
# This is more forgiving than traditional mode

SecAction \
    "id:900110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# -- Anomaly Scoring Severity Levels -------------------------------------------

SecAction \
    "id:900100,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.critical_anomaly_score=5,\
    setvar:tx.error_anomaly_score=4,\
    setvar:tx.warning_anomaly_score=3,\
    setvar:tx.notice_anomaly_score=2"

# -- HTTP Policy Settings ------------------------------------------------------

# Allowed HTTP methods (OpenRTB uses POST, plus OPTIONS for CORS)
SecAction \
    "id:900200,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS'"

# Allowed request content types
SecAction \
    "id:900220,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_request_content_type=|application/json|application/x-www-form-urlencoded|text/plain|'"

# Allowed HTTP versions
SecAction \
    "id:900230,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# Restricted file extensions (not applicable to API, but keep defaults)
SecAction \
    "id:900240,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# -- Sampling Mode (Disabled - we want full protection) ------------------------

SecAction \
    "id:900400,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.sampling_percentage=100"

# -- GeoIP Database (Optional - uncomment if you have GeoIP) -------------------

# SecGeoLookupDB /usr/share/GeoIP/GeoLite2-Country.mmdb

# -- Rule Exclusions for Ad-Tech -----------------------------------------------

# Disable some rules that conflict with legitimate JSON API traffic

# Exclude SQL injection detection in JSON values (causes false positives on ad URLs)
# Rule 942100: SQL Injection Attack Detected via libinjection
SecRuleUpdateTargetById 942100 "!ARGS:site.page"
SecRuleUpdateTargetById 942100 "!ARGS:site.ref"
SecRuleUpdateTargetById 942100 "!ARGS:app.bundle"
SecRuleUpdateTargetById 942100 "!ARGS:user.id"

# Exclude path traversal detection on URL fields (ad creatives often have paths)
SecRuleUpdateTargetById 930110 "!ARGS:site.page"
SecRuleUpdateTargetById 930110 "!ARGS:site.ref"
SecRuleUpdateTargetById 930120 "!ARGS:site.page"
SecRuleUpdateTargetById 930120 "!ARGS:site.ref"

# Exclude XSS detection on creative/markup fields (HTML is expected)
SecRuleUpdateTargetById 941100 "!ARGS:ext"
SecRuleUpdateTargetById 941110 "!ARGS:ext"
SecRuleUpdateTargetById 941120 "!ARGS:ext"
SecRuleUpdateTargetById 941130 "!ARGS:ext"
SecRuleUpdateTargetById 941140 "!ARGS:ext"

# -- Disable Rules That Don't Apply to APIs ------------------------------------

# 920300: Request Missing Accept Header (many bidders don't send it)
SecRuleRemoveById 920300

# 920420: Request content type is not allowed (we handle this ourselves)
SecRuleRemoveById 920420

# 921110: HTTP Request Smuggling Attack (false positives on JSON)
SecRuleRemoveById 921110

# 932130: Remote Command Execution (false positives on certain ad markup)
SecRuleRemoveById 932130

# -- End of CRS Setup ----------------------------------------------------------
