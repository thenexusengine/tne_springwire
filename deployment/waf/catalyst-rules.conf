# =============================================================================
# Catalyst Ad-Tech Specific WAF Rules
# =============================================================================
# Custom rules for protecting OpenRTB auction endpoints from ad-tech specific
# attacks: bid manipulation, inventory fraud, malformed requests, etc.
# =============================================================================

# -- Rule ID Ranges ------------------------------------------------------------
# 9500000-9500099: Request validation
# 9500100-9500199: OpenRTB structure validation
# 9500200-9500299: Bid manipulation protection
# 9500300-9500399: Bot/fraud detection
# 9500400-9500499: Rate abuse patterns
# 9500500-9500599: Known bad actors
# =============================================================================

# =============================================================================
# REQUEST VALIDATION (9500000-9500099)
# =============================================================================

# Block requests without Content-Type header on POST
SecRule REQUEST_METHOD "@streq POST" \
    "id:9500000,\
    phase:1,\
    deny,\
    status:400,\
    log,\
    msg:'POST request without Content-Type header',\
    tag:'catalyst/request-validation',\
    chain"
    SecRule &REQUEST_HEADERS:Content-Type "@eq 0"

# Block non-JSON content type on auction endpoint
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500001,\
    phase:1,\
    deny,\
    status:415,\
    log,\
    msg:'Auction endpoint requires application/json content type',\
    tag:'catalyst/request-validation',\
    chain"
    SecRule REQUEST_HEADERS:Content-Type "!@contains application/json" \
        "chain"
        SecRule REQUEST_METHOD "@streq POST"

# Block empty request bodies on POST to auction
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500002,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Empty request body on auction endpoint',\
    tag:'catalyst/request-validation',\
    chain"
    SecRule REQUEST_BODY "@eq ''" \
        "chain"
        SecRule REQUEST_METHOD "@streq POST"

# Block requests with null bytes (injection attempt)
SecRule REQUEST_BODY "@contains \x00" \
    "id:9500003,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Null byte in request body',\
    tag:'catalyst/request-validation'"

# =============================================================================
# OPENRTB STRUCTURE VALIDATION (9500100-9500199)
# =============================================================================

# Require 'id' field in bid request
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500100,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'OpenRTB bid request missing required id field',\
    tag:'catalyst/openrtb-validation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "!@rx \"id\"\s*:\s*\""

# Require 'imp' array in bid request
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500101,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'OpenRTB bid request missing required imp array',\
    tag:'catalyst/openrtb-validation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "!@rx \"imp\"\s*:\s*\["

# Block excessive impressions (DoS via large requests)
# More than 100 impression objects
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500102,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Too many impressions in bid request (max 100)',\
    tag:'catalyst/openrtb-validation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        # Count opening braces after "imp": [ - rough heuristic
        SecRule REQUEST_BODY "@rx (?:\"imp\"\s*:\s*\[(?:[^\]]*\{){101})"

# Block requests with both site and app (OpenRTB violation)
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500103,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'OpenRTB violation: both site and app objects present',\
    tag:'catalyst/openrtb-validation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "@rx \"site\"\s*:\s*\{" \
            "chain"
            SecRule REQUEST_BODY "@rx \"app\"\s*:\s*\{"

# =============================================================================
# BID MANIPULATION PROTECTION (9500200-9500299)
# =============================================================================

# Block suspiciously high bidfloor (potential price manipulation)
# Bidfloor > $1000 CPM is almost certainly malicious
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500200,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Suspicious bidfloor value (>1000)',\
    tag:'catalyst/bid-manipulation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "@rx \"bidfloor\"\s*:\s*([1-9]\d{3,}|[1-9]\d{2}\d)"

# Block negative bidfloor (invalid)
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500201,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Negative bidfloor value',\
    tag:'catalyst/bid-manipulation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "@rx \"bidfloor\"\s*:\s*-"

# Block suspiciously high tmax (timeout manipulation)
# tmax > 30000ms (30s) is almost certainly an attack
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500202,\
    phase:2,\
    deny,\
    status:400,\
    log,\
    msg:'Suspicious tmax value (>30000ms)',\
    tag:'catalyst/bid-manipulation',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_BODY "@rx \"tmax\"\s*:\s*([3-9]\d{4,}|\d{6,})"

# =============================================================================
# BOT/FRAUD DETECTION (9500300-9500399)
# =============================================================================

# Block known bot user agents
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/nginx/modsecurity/rules/bad-user-agents.txt" \
    "id:9500300,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Known bot user agent blocked',\
    tag:'catalyst/bot-detection'"

# Block requests with missing or empty User-Agent on auction
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500301,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Missing User-Agent on auction request',\
    tag:'catalyst/bot-detection',\
    chain"
    SecRule &REQUEST_HEADERS:User-Agent "@eq 0"

# Block curl/wget/python-requests on auction (likely scraping/testing)
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500302,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Suspicious HTTP client on auction endpoint',\
    tag:'catalyst/bot-detection',\
    chain"
    SecRule REQUEST_HEADERS:User-Agent "@rx (?i)^(curl|wget|python-requests|python-urllib|Go-http-client|Java/)" \
        "chain"
        # Allow if they have a valid API key (legitimate testing)
        SecRule &REQUEST_HEADERS:X-API-Key "@eq 0"

# Block requests claiming to be from datacenter IPs with residential device info
# This catches basic device spoofing attempts
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:9500303,\
    phase:2,\
    log,\
    msg:'Suspicious: mobile device type from non-mobile User-Agent',\
    tag:'catalyst/fraud-detection',\
    severity:'WARNING',\
    chain"
    SecRule REQUEST_BODY "@rx \"devicetype\"\s*:\s*[14]" \
        "chain"
        SecRule REQUEST_HEADERS:User-Agent "!@rx (?i)(android|iphone|ipad|mobile|tablet)"

# =============================================================================
# RATE ABUSE PATTERNS (9500400-9500499)
# =============================================================================

# Track auction requests per IP for anomaly detection
SecAction \
    "id:9500400,\
    phase:1,\
    pass,\
    nolog,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.auction_count=+1,\
    expirevar:ip.auction_count=60"

# Alert on high request volume (>200 requests/minute from single IP)
SecRule IP:auction_count "@gt 200" \
    "id:9500401,\
    phase:1,\
    pass,\
    log,\
    msg:'High request volume from single IP: %{IP.auction_count}/min',\
    tag:'catalyst/rate-abuse',\
    severity:'WARNING'"

# Block extreme request volume (>500 requests/minute from single IP)
SecRule IP:auction_count "@gt 500" \
    "id:9500402,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded: %{IP.auction_count}/min',\
    tag:'catalyst/rate-abuse'"

# =============================================================================
# KNOWN BAD ACTORS (9500500-9500599)
# =============================================================================

# Block requests from known bad IP ranges (load from file)
SecRule REMOTE_ADDR "@pmFromFile /etc/nginx/modsecurity/rules/bad-ips.txt" \
    "id:9500500,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Request from known bad IP',\
    tag:'catalyst/bad-actor'"

# Block requests with known fraudulent publisher IDs
SecRule REQUEST_BODY "@pmFromFile /etc/nginx/modsecurity/rules/bad-publishers.txt" \
    "id:9500501,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Request contains known fraudulent publisher ID',\
    tag:'catalyst/bad-actor'"

# Block requests with known fraudulent domains
SecRule REQUEST_BODY "@pmFromFile /etc/nginx/modsecurity/rules/bad-domains.txt" \
    "id:9500502,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Request contains known fraudulent domain',\
    tag:'catalyst/bad-actor'"

# =============================================================================
# ALLOWLIST BYPASS FOR TRUSTED SOURCES (9500900-9500999)
# =============================================================================

# Allow health checks without WAF inspection
SecRule REQUEST_URI "@rx ^/health(/ready)?$" \
    "id:9500900,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Allow metrics endpoint without WAF inspection
SecRule REQUEST_URI "@streq /metrics" \
    "id:9500901,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Allow status endpoint without WAF inspection
SecRule REQUEST_URI "@streq /status" \
    "id:9500902,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Allowlist for trusted SSP/DSP IPs (populate from file)
SecRule REMOTE_ADDR "@pmFromFile /etc/nginx/modsecurity/rules/trusted-ips.txt" \
    "id:9500910,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=DetectionOnly"

# =============================================================================
# END OF CATALYST RULES
# =============================================================================
