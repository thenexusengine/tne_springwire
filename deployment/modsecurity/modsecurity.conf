# ModSecurity Configuration for Catalyst Auction Server
# Optimized for OpenRTB/Ad-Tech traffic patterns
# Based on OWASP ModSecurity CRS v3.3.5 recommended configuration

# -- Rule engine initialization ----------------------------------------------

# Enable ModSecurity, attaching it to every transaction
SecRuleEngine On

# -- Request body handling ---------------------------------------------------

# Allow ModSecurity to access request bodies
SecRequestBodyAccess On

# Enable JSON request body parser
SecRequestBodyLimitAction Reject
SecRequestBodyJsonDepthLimit 512

# Maximum request body size (2MB for OpenRTB bid requests)
SecRequestBodyLimit 2097152
SecRequestBodyNoFilesLimit 2097152

# Store up to 2MB in memory, everything else to disk
SecRequestBodyInMemoryLimit 131072

# What to do if the request body size is above our configured limit
SecRequestBodyLimitAction Reject

# Verify that we've correctly processed the request body
SecRule REQBODY_ERROR "!@eq 0" \
"id:'200001', phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

# By default be strict with what we accept in the multipart/form-data
SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
"id:'200002',phase:2,t:none,log,deny,status:400, \
msg:'Multipart request body failed strict validation: \
PE %{REQBODY_PROCESSOR_ERROR}, \
BQ %{MULTIPART_BOUNDARY_QUOTED}, \
BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
DB %{MULTIPART_DATA_BEFORE}, \
DA %{MULTIPART_DATA_AFTER}, \
HF %{MULTIPART_HEADER_FOLDING}, \
LF %{MULTIPART_LF_LINE}, \
SM %{MULTIPART_MISSING_SEMICOLON}, \
IQ %{MULTIPART_INVALID_QUOTING}, \
IP %{MULTIPART_INVALID_PART}, \
IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"

# Did we see anything that might be a boundary?
SecRule MULTIPART_UNMATCHED_BOUNDARY "@eq 1" \
    "id:'200003',phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"

# -- Response body handling --------------------------------------------------

# Allow ModSecurity to access response bodies
SecResponseBodyAccess On

# Which response MIME types do you want to inspect?
SecResponseBodyMimeType text/plain text/html text/xml application/json

# Buffer response bodies of up to 512KB in length
SecResponseBodyLimit 524288

# What happens when we encounter a response body larger than configured limit?
SecResponseBodyLimitAction ProcessPartial

# -- Filesystem configuration ------------------------------------------------

# The location where ModSecurity stores temporary files
SecTmpDir /tmp/

# The location where ModSecurity will keep its persistent data (mostly IP reputation)
SecDataDir /tmp/

# -- File uploads handling configuration -------------------------------------

# The location where ModSecurity stores intercepted uploaded files
SecUploadDir /tmp/
SecUploadKeepFiles RelevantOnly

# -- Debug log configuration -------------------------------------------------

# Default: Off (set via ENV var)
# SecDebugLog /var/log/modsec/debug.log
# SecDebugLogLevel 0

# -- Audit log configuration -------------------------------------------------

# Log the transactions that are marked by a rule, as well as those that
# trigger a server error
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"

# Log everything we know about a transaction (use JSON for easy parsing)
SecAuditLogParts ABIJDEFHZ

# Use a single file for logging (can be changed to concurrent for high traffic)
SecAuditLogType Serial
SecAuditLog /var/log/modsec/audit.log

# JSON format for easier parsing by SIEM/log aggregators
SecAuditLogFormat JSON

# -- Miscellaneous -----------------------------------------------------------

# Use the most commonly used application/x-www-form-urlencoded parameter
# separator
SecArgumentSeparator &

# Settle on version 0 (zero) cookies, as that is what most applications use
SecCookieFormat 0

# Specify your Unicode Code Point (default is UTF-8)
SecUnicodeMapFile unicode.map 20127

# Improve the quality of ModSecurity by sharing information about your
# current ModSecurity version and dependencies versions (opt-in)
SecStatusEngine Off

# -- Performance tuning ------------------------------------------------------

# Increase PCRE match limits for complex JSON patterns
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Collection timeout (garbage collection)
SecCollectionTimeout 600

# -- Custom configuration for ad-tech ----------------------------------------

# Disable XML parsing (OpenRTB uses JSON)
SecRule REQUEST_HEADERS:Content-Type "@rx application/xml" \
    "id:'200004',phase:1,t:none,pass,nolog,ctl:requestBodyProcessor=XML"

# Enable JSON parsing for OpenRTB
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \
    "id:'200005',phase:1,t:none,pass,nolog,ctl:requestBodyProcessor=JSON"

# -- Include OWASP CRS -------------------------------------------------------

# OWASP ModSecurity Core Rule Set (CRS) configuration
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf

# OWASP CRS rules
Include /etc/modsecurity.d/owasp-crs/rules/*.conf

# Custom rules for OpenRTB/Ad-Tech
Include /etc/nginx/modsecurity.d/custom-rules/*.conf
