# OWASP ModSecurity Core Rule Set (CRS) Setup
# Tuned for OpenRTB Ad-Tech Auction Server
# Based on CRS v3.3.5 crs-setup.conf.example

# -- Paranoia Level Initialization -------------------------------------------

# Paranoia Level (PL) 1: Basic protection with minimal false positives
# Paranoia Level (PL) 2: Moderate protection (recommended for production)
# Paranoia Level (PL) 3: High protection (expect false positives)
# Paranoia Level (PL) 4: Very high protection (extensive tuning required)

# Set paranoia level to 2 for balanced protection
SecAction \
 "id:900000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=2"

# Executing Paranoia Level (controls which rules actually execute)
SecAction \
 "id:900001,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.executing_paranoia_level=2"

# -- Anomaly Scoring Settings ------------------------------------------------

# Inbound Anomaly Score Threshold
# Block if total anomaly score >= 5
SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound Anomaly Score Threshold
SecAction \
 "id:900111,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.outbound_anomaly_score_threshold=4"

# -- Application Specific Rule Exclusions ------------------------------------

# OpenRTB uses large JSON payloads with nested objects
# Increase argument limits

SecAction \
 "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.max_num_args=512,\
  setvar:tx.arg_name_length=400,\
  setvar:tx.arg_length=8000,\
  setvar:tx.total_arg_length=64000,\
  setvar:tx.max_file_size=2097152,\
  setvar:tx.combined_file_sizes=2097152"

# -- HTTP Policy Settings ----------------------------------------------------

# Allowed HTTP methods
SecAction \
 "id:900300,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE'"

# Allowed Request Content Types (OpenRTB = JSON)
SecAction \
 "id:900301,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=application/json|application/x-www-form-urlencoded|multipart/form-data'"

# Allowed HTTP Versions
SecAction \
 "id:900302,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# Restricted file extensions (not applicable for API, but keeping for security)
SecAction \
 "id:900303,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# Restricted request headers
SecAction \
 "id:900304,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/'"

# -- Anomaly Scoring Severity Levels -----------------------------------------

# Critical: 5 points
SecAction \
 "id:900400,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.critical_anomaly_score=5"

# Error: 4 points
SecAction \
 "id:900401,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.error_anomaly_score=4"

# Warning: 3 points
SecAction \
 "id:900402,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.warning_anomaly_score=3"

# Notice: 2 points
SecAction \
 "id:900403,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.notice_anomaly_score=2"

# -- Attack-Specific Score Thresholds ----------------------------------------

# SQL Injection
SecAction \
 "id:900500,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.sql_injection_score=5"

# XSS
SecAction \
 "id:900501,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.xss_score=5"

# RFI (Remote File Inclusion)
SecAction \
 "id:900502,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.rfi_score=5"

# LFI (Local File Inclusion)
SecAction \
 "id:900503,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.lfi_score=5"

# RCE (Remote Code Execution)
SecAction \
 "id:900504,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.rce_score=5"

# Command Injection
SecAction \
 "id:900505,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.command_injection_score=5"

# Session Fixation
SecAction \
 "id:900506,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.session_fixation_score=5"

# -- GeoIP / IP Reputation Settings ------------------------------------------

# Block high risk countries (optional - disabled by default)
# Uncomment and configure if needed
# SecAction \
#  "id:900600,\
#   phase:1,\
#   nolog,\
#   pass,\
#   t:none,\
#   setvar:'tx.high_risk_country_codes='"

# -- Collection Timeouts -----------------------------------------------------

# How long to keep track of IP addresses and sessions
SecAction \
 "id:900700,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.ip_collection_timeout=600,\
  setvar:tx.session_collection_timeout=600"

# -- Application-Specific Settings -------------------------------------------

# Ad-Tech / OpenRTB specific configuration

# Don't block on large JSON arg count (bid requests have many impressions)
SecAction \
 "id:900800,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.http_violation_score=5"

# Set sampling percentage (100 = check all requests, 10 = check 10%)
SecAction \
 "id:900801,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.sampling_percentage=100"

# -- Initialization Complete -------------------------------------------------

SecMarker "END_CRS_SETUP"
