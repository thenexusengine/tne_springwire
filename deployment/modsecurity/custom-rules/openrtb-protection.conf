# Custom ModSecurity Rules for OpenRTB Ad-Tech Protection
# Rule ID range: 10000-19999 (custom rules)

# -- General Ad-Tech Attack Detection ----------------------------------------

# Rule 10001: Detect bid manipulation attempts (negative prices, absurdly high prices)
SecRule REQUEST_BODY "@rx \"price\":\s*(-\d+|[1-9]\d{6,})" \
    "id:10001,\
    phase:2,\
    block,\
    t:none,\
    msg:'Bid manipulation attempt detected: invalid price value',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-json',\
    tag:'platform-multi',\
    tag:'attack-injection',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# Rule 10002: Detect publisher ID enumeration attempts
SecRule REQUEST_BODY "@rx \"(publisher|pub)\.id\":\s*\"[^\"]{100,}\"" \
    "id:10002,\
    phase:2,\
    block,\
    t:none,\
    msg:'Publisher ID enumeration attempt: excessively long publisher ID',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'language-json',\
    tag:'attack-enumeration',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# Rule 10003: Detect malicious JavaScript in creative content
SecRule REQUEST_BODY "@rx <script[^>]*>.*?<\\/script>" \
    "id:10003,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'Malicious creative content: script tag detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'language-html',\
    tag:'attack-xss',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10004: Detect iframe injection in creatives
SecRule REQUEST_BODY "@rx <iframe[^>]*(src|srcdoc)\\s*=\\s*[\"'][^\"']*javascript:" \
    "id:10004,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'Malicious creative content: javascript iframe detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'language-html',\
    tag:'attack-xss',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10005: Detect excessively deep JSON nesting (DoS)
SecRule REQUEST_BODY "@rx (\\{[^}]*){15,}" \
    "id:10005,\
    phase:2,\
    block,\
    t:none,\
    msg:'JSON depth attack: excessive nesting detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'language-json',\
    tag:'attack-dos',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# Rule 10006: Detect SQL injection patterns in bid request fields
SecRule REQUEST_BODY "@rx (?i)(union.*select|select.*from|insert.*into|delete.*from|update.*set|drop.*table)" \
    "id:10006,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'SQL injection attempt in bid request',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-sql',\
    tag:'attack-sqli',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# Rule 10007: Detect path traversal attempts
SecRule REQUEST_BODY "@rx \\.\\.\\/|\\.\\.\\\\" \
    "id:10007,\
    phase:2,\
    block,\
    t:none,\
    msg:'Path traversal attempt detected in request body',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'attack-lfi',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10008: Detect command injection patterns
SecRule REQUEST_BODY "@rx (?i)(;\\s*(wget|curl|bash|sh|cmd|powershell)|\\$\\(|`)" \
    "id:10008,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'Command injection attempt detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'attack-rce',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# -- Bot & Scanner Detection -------------------------------------------------

# Rule 10100: Detect known malicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(sqlmap|nikto|nmap|masscan|nessus|burp|metasploit|havij|acunetix)" \
    "id:10100,\
    phase:1,\
    block,\
    t:none,t:lowercase,\
    msg:'Malicious scanner detected in User-Agent',\
    logdata:'User-Agent: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'attack-reconnaissance',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10101: Detect missing or suspicious User-Agent for auction endpoint
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:10101,\
    phase:1,\
    pass,\
    t:none,\
    chain,\
    nolog"
    SecRule REQUEST_HEADERS:User-Agent "@rx ^$" \
        "t:none,\
        block,\
        msg:'Missing User-Agent header on auction endpoint',\
        severity:WARNING,\
        tag:'application-multi',\
        tag:'attack-bot',\
        setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# Rule 10102: Detect bot signatures in User-Agent
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(bot|crawl|spider|scraper|scanner)" \
    "id:10102,\
    phase:1,\
    block,\
    t:none,t:lowercase,\
    msg:'Bot detected accessing auction endpoint',\
    logdata:'User-Agent: %{MATCHED_VAR}',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'attack-bot',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# -- OpenRTB Field Validation ------------------------------------------------

# Rule 10200: Validate OpenRTB bid request structure
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:10200,\
    phase:2,\
    pass,\
    t:none,\
    chain,\
    nolog"
    SecRule REQUEST_BODY "!@rx \"id\"" \
        "t:none,\
        block,\
        msg:'Invalid OpenRTB request: missing required id field',\
        severity:ERROR,\
        tag:'application-multi',\
        tag:'language-json',\
        tag:'attack-protocol',\
        setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10201: Detect missing impression array
SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
    "id:10201,\
    phase:2,\
    pass,\
    t:none,\
    chain,\
    nolog"
    SecRule REQUEST_BODY "!@rx \"imp\"\\s*:\\s*\\[" \
        "t:none,\
        block,\
        msg:'Invalid OpenRTB request: missing or malformed imp array',\
        severity:ERROR,\
        tag:'application-multi',\
        tag:'language-json',\
        tag:'attack-protocol',\
        setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# Rule 10202: Detect excessive number of impressions (DoS)
SecRule REQUEST_BODY "@rx \"imp\"\\s*:\\s*\\[[^\\]]{50000,}" \
    "id:10202,\
    phase:2,\
    block,\
    t:none,\
    msg:'DoS attempt: excessive impression count',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'language-json',\
    tag:'attack-dos',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# -- Publisher Authentication Bypass Attempts --------------------------------

# Rule 10300: Detect multiple publisher IDs in single request (bypass attempt)
SecRule REQUEST_BODY "@rx (\"(publisher|pub)\.id\"[^}]*){2,}" \
    "id:10300,\
    phase:2,\
    block,\
    t:none,\
    msg:'Multiple publisher IDs detected: authentication bypass attempt',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'attack-auth-bypass',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# Rule 10301: Detect null byte injection in publisher ID
SecRule REQUEST_BODY "@rx \"(publisher|pub)\.id\"\\s*:\\s*\"[^\"]*\\\\u0000" \
    "id:10301,\
    phase:2,\
    block,\
    t:none,\
    msg:'Null byte injection in publisher ID',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'attack-injection',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# -- Rate Limiting & Resource Abuse ------------------------------------------

# Rule 10400: Detect rapid successive requests from same IP (layer 7 DoS)
SecRule IP:dos_counter "@gt 100" \
    "id:10400,\
    phase:1,\
    block,\
    t:none,\
    msg:'Layer 7 DoS detected: excessive requests from IP',\
    logdata:'IP: %{REMOTE_ADDR}, Counter: %{IP.dos_counter}',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'attack-dos',\
    expirevar:IP.dos_counter=60,\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

SecRule IP:dos_counter "@lt 100" \
    "id:10401,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:IP.dos_counter=+1,\
    expirevar:IP.dos_counter=60"

# -- Creative Content Filtering ----------------------------------------------

# Rule 10500: Detect cryptocurrency mining scripts in creatives
SecRule REQUEST_BODY "@rx (?i)(coinhive|cryptonight|webminer|miner\\.start)" \
    "id:10500,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'Cryptocurrency mining detected in creative',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'attack-malware',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# Rule 10501: Detect malicious redirects
SecRule REQUEST_BODY "@rx window\\.location\\s*=|document\\.location\\s*=|location\\.href\\s*=" \
    "id:10501,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'Suspicious redirect in creative content',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:WARNING,\
    tag:'application-multi',\
    tag:'attack-redirection',\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# Rule 10502: Detect eval() usage (code injection vector)
SecRule REQUEST_BODY "@rx \\beval\\s*\\(" \
    "id:10502,\
    phase:2,\
    block,\
    t:none,t:lowercase,\
    msg:'eval() detected in creative: potential code injection',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:ERROR,\
    tag:'application-multi',\
    tag:'attack-injection',\
    setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# -- Protocol Compliance -----------------------------------------------------

# Rule 10600: Enforce HTTPS for auction endpoint (if enabled)
# Uncomment if you want to enforce HTTPS-only for auctions
# SecRule REQUEST_URI "@beginsWith /openrtb2/auction" \
#     "id:10600,\
#     phase:1,\
#     pass,\
#     t:none,\
#     chain,\
#     nolog"
#     SecRule REQUEST_SCHEME "!@streq https" \
#         "t:none,\
#         block,\
#         msg:'Auction endpoint requires HTTPS',\
#         severity:ERROR,\
#         tag:'application-multi',\
#         tag:'attack-protocol',\
#         setvar:'tx.anomaly_score_pl1=+%{tx.error_anomaly_score}'"

# -- End of Custom Rules -----------------------------------------------------
